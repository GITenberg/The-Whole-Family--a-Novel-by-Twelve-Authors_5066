sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: HVrrol13OZk3JtiWWQ6FM0p78y0zyM55/0dtX4gtldzLVM6o+G4uv+1kmv2Fue01tPCU1xEx5YdVKyS0+zuA99p0onO3DZuMVdYpKRmrUsQOqBDtFFcUrIeaFWXbYOTm8ra5YjLJB0wxsyJuoFelfBm1DKx9kObLLyetSgrotJ2ycwyW0gRRXrYZFzMX37zFlWiCqRTpRMhgKr5clZHDGTSDaNFwaBfbyue1gRjmLCKGC/3u/ijGF+KHSnPrft3iWhNaHJweEP9rBqWFwyokDtVpTk0gUbpJNPyGmOQW2SSurK6Jr4V2iZrlhF4Kbh6mjz/wOjyYIwhTApGc+U69GcaFRcIopiNkAS8ONYnuyRZoaDq/PWrCwcpu6yjGvtDCSeERYFz1W4EiN9RlrWk7u8WW9+JsuDuDrQHuqCMDFmbrleZw076E1WERxM/9G6ISyTfhC48m5YFjaGi/LEfFoAt8oVYfhOif5H4Rb942DHXW2793J+fMFIbau5WSDG7YOyaplCU+N1srl4k7OGIldcWcA8QVqDV6iWFH5UorP6aGOC9IxhSlA1VqUp6I6hrl6LrzXt26hDrQ/4iUGlmnwHSRu1BfNENipSZ81K0ZdVCb0mbQW6M4kZ9ZxA6zBESG5vNhS9436Nl4u4ogEO4I6gjqSxLjgjUDrK5uR6BvZhI=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/The-Whole-Family--a-Novel-by-Twelve-Authors_5066
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy